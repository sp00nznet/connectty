stages:
  - build

variables:
  npm_config_cache: "$CI_PROJECT_DIR/.npm"

# Cache node_modules across builds (per-platform)
# Note: Uses PLATFORM_CACHE_KEY variable instead of CI_JOB_NAME to avoid colons
# (Windows doesn't allow : in file/folder names)
.node_cache:
  cache:
    key: "${PLATFORM_CACHE_KEY}-${CI_COMMIT_REF_SLUG}"
    paths:
      - .npm/
      - node_modules/
      - packages/*/node_modules/

# Template for creating .env file from CI variables
# Add these variables in GitLab Settings > CI/CD > Variables:
#   - GOOGLE_CLIENT_ID
#   - GOOGLE_CLIENT_SECRET
#   - GH_OAUTH_CLIENT_ID
#   - GH_OAUTH_CLIENT_SECRET
.create_env_unix: &create_env_unix
  - |
    cat > .env << EOF
    GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-}
    GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:-}
    GH_OAUTH_CLIENT_ID=${GH_OAUTH_CLIENT_ID:-}
    GH_OAUTH_CLIENT_SECRET=${GH_OAUTH_CLIENT_SECRET:-}
    EOF

# ===================
# Windows Build
# ===================
build:windows:
  stage: build
  extends: .node_cache
  tags:
    - windows
  variables:
    PLATFORM_CACHE_KEY: "build-windows"
  before_script:
    # Install build dependencies for native modules (better-sqlite3, node-pty, etc.)
    # Use Node 20 LTS (Iron) - Node 24 requires C++20 which breaks native module builds
    - choco install -y 7zip python3 visualstudio2022buildtools visualstudio2022-workload-vctools --no-progress
    # Uninstall any existing Node.js first to avoid MSI conflicts
    - choco uninstall -y nodejs nodejs.install nodejs-lts --force 2>$null; $true
    - choco install -y nodejs --version=20.18.2 --no-progress
    - Import-Module "$env:ChocolateyInstall\helpers\chocolateyProfile.psm1"; refreshenv
    - node --version
    - npm --version
    - python --version
    # Create .env file from CI variables (PowerShell)
    - |
      @"
      GOOGLE_CLIENT_ID=$env:GOOGLE_CLIENT_ID
      GOOGLE_CLIENT_SECRET=$env:GOOGLE_CLIENT_SECRET
      GH_OAUTH_CLIENT_ID=$env:GH_OAUTH_CLIENT_ID
      GH_OAUTH_CLIENT_SECRET=$env:GH_OAUTH_CLIENT_SECRET
      "@ | Out-File -FilePath .env -Encoding utf8
  script:
    - npm ci
    - npm run dist:win
  artifacts:
    name: "connectty-windows-${CI_COMMIT_SHORT_SHA}"
    paths:
      - packages/desktop/release/*.exe
      - packages/desktop/release/*.msi
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
      allow_failure: true

# ===================
# Linux Build
# ===================
build:linux:
  stage: build
  extends: .node_cache
  tags:
    - debian
  # Note: image directive only works with Docker executors, not shell executors
  variables:
    PLATFORM_CACHE_KEY: "build-linux"
  before_script:
    - apt-get update
    - apt-get install -y build-essential python3 ruby ruby-dev rpm libfuse2 curl
    - gem install fpm --no-document
    # Install Node.js 20 LTS via NodeSource
    - curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
    - apt-get install -y nodejs
    - node --version
    - npm --version
    # Create .env file from CI variables
    - *create_env_unix
  script:
    - npm ci
    - npm run generate-icons
    - npm run build -w @connectty/shared
    - cd packages/desktop
    - npm run build
    - npm exec electron-builder -- --linux deb AppImage
  artifacts:
    name: "connectty-linux-${CI_COMMIT_SHORT_SHA}"
    paths:
      - packages/desktop/release/*.deb
      - packages/desktop/release/*.AppImage
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
      allow_failure: true

# ===================
# macOS Build
# ===================
build:macos:
  stage: build
  extends: .node_cache
  tags:
    - macos
  variables:
    PLATFORM_CACHE_KEY: "build-macos"
  before_script:
    - node --version || brew install node@20
    - npm --version
    # Create .env file from CI variables
    - *create_env_unix
  script:
    - npm ci
    - npm run generate-icons
    - npm run build -w @connectty/shared
    - cd packages/desktop
    - npm run build
    - npm exec electron-builder -- --mac
  artifacts:
    name: "connectty-macos-${CI_COMMIT_SHORT_SHA}"
    paths:
      - packages/desktop/release/*.dmg
      - packages/desktop/release/*.zip
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
      allow_failure: true

# ===================
# Build All (triggered manually or by tag)
# ===================
build:all:
  stage: build
  tags:
    - linux
  image: alpine:latest
  script:
    - echo "Triggering all platform builds"
  needs:
    - job: build:windows
      optional: true
    - job: build:linux
      optional: true
    - job: build:macos
      optional: true
  rules:
    - if: $CI_COMMIT_TAG
