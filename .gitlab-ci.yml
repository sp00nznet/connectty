stages:
  - build
  - docker
  - deploy

variables:
  npm_config_cache: "$CI_PROJECT_DIR/.npm"
  # Docker registry configuration
  DOCKER_REGISTRY: $CI_REGISTRY
  SERVER_IMAGE: $CI_REGISTRY_IMAGE/server
  WEB_IMAGE: $CI_REGISTRY_IMAGE/web

# Cache node_modules across builds (per-platform)
# Note: Uses PLATFORM_CACHE_KEY variable instead of CI_JOB_NAME to avoid colons
# (Windows doesn't allow : in file/folder names)
.node_cache:
  cache:
    key: "${PLATFORM_CACHE_KEY}-${CI_COMMIT_REF_SLUG}"
    paths:
      - .npm/
      - node_modules/
      - packages/*/node_modules/

# Template for creating .env file from CI variables
# Add these variables in GitLab Settings > CI/CD > Variables:
#   - GOOGLE_CLIENT_ID
#   - GOOGLE_CLIENT_SECRET
#   - GH_OAUTH_CLIENT_ID
#   - GH_OAUTH_CLIENT_SECRET
.create_env_unix: &create_env_unix
  - |
    cat > .env << EOF
    GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-}
    GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:-}
    GH_OAUTH_CLIENT_ID=${GH_OAUTH_CLIENT_ID:-}
    GH_OAUTH_CLIENT_SECRET=${GH_OAUTH_CLIENT_SECRET:-}
    EOF

# ===================
# Windows Build
# ===================
build:windows:
  stage: build
  extends: .node_cache
  tags:
    - windows
  variables:
    PLATFORM_CACHE_KEY: "build-windows"
  before_script:
    # Install build dependencies for native modules (better-sqlite3, node-pty, etc.)
    # Use Node 20 LTS (Iron) - Node 24 requires C++20 which breaks native module builds
    - choco install -y 7zip python3 visualstudio2022buildtools visualstudio2022-workload-vctools --no-progress
    # Uninstall any existing Node.js first to avoid MSI conflicts
    - choco uninstall -y nodejs nodejs.install nodejs-lts --force 2>$null; $true
    - choco install -y nodejs --version=20.18.2 --no-progress
    - Import-Module "$env:ChocolateyInstall\helpers\chocolateyProfile.psm1"; refreshenv
    - node --version
    - npm --version
    - python --version
    # Create .env file from CI variables (PowerShell)
    - |
      @"
      GOOGLE_CLIENT_ID=$env:GOOGLE_CLIENT_ID
      GOOGLE_CLIENT_SECRET=$env:GOOGLE_CLIENT_SECRET
      GH_OAUTH_CLIENT_ID=$env:GH_OAUTH_CLIENT_ID
      GH_OAUTH_CLIENT_SECRET=$env:GH_OAUTH_CLIENT_SECRET
      "@ | Out-File -FilePath .env -Encoding utf8
  script:
    - npm ci
    - npm run dist:win
  artifacts:
    name: "connectty-windows-${CI_COMMIT_SHORT_SHA}"
    paths:
      - packages/desktop/release/*.exe
      - packages/desktop/release/*.msi
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
      allow_failure: true

# ===================
# Linux Build
# ===================
build:linux:
  stage: build
  extends: .node_cache
  tags:
    - debian
  # Note: image directive only works with Docker executors, not shell executors
  variables:
    PLATFORM_CACHE_KEY: "build-linux"
  before_script:
    - apt-get update
    - apt-get install -y build-essential python3 ruby ruby-dev rpm libfuse2 curl
    - gem install fpm --no-document
    # Install Node.js 20 LTS via NodeSource
    - curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
    - apt-get install -y nodejs
    - node --version
    - npm --version
    # Create .env file from CI variables
    - *create_env_unix
  script:
    - npm ci
    - npm run generate-icons
    - npm run build -w @connectty/shared
    - cd packages/desktop
    - npm run build
    # Build targets sequentially to avoid resource exhaustion
    - npm exec electron-builder -- --linux AppImage
    - npm exec electron-builder -- --linux deb
  artifacts:
    name: "connectty-linux-${CI_COMMIT_SHORT_SHA}"
    paths:
      - packages/desktop/release/*.deb
      - packages/desktop/release/*.AppImage
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
      allow_failure: true

# ===================
# macOS Build
# ===================
build:macos:
  stage: build
  extends: .node_cache
  tags:
    - macos
  variables:
    PLATFORM_CACHE_KEY: "build-macos"
  before_script:
    - node --version || brew install node@20
    - npm --version
    # Create .env file from CI variables
    - *create_env_unix
  script:
    - npm ci
    - npm run generate-icons
    - npm run build -w @connectty/shared
    - cd packages/desktop
    - npm run build
    - npm exec electron-builder -- --mac
  artifacts:
    name: "connectty-macos-${CI_COMMIT_SHORT_SHA}"
    paths:
      - packages/desktop/release/*.dmg
      - packages/desktop/release/*.zip
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
      allow_failure: true

# ===================
# Server Docker Build
# ===================
build:server:
  stage: docker
  tags:
    - debian
  variables:
    PLATFORM_CACHE_KEY: "build-server"
  before_script:
    # Install Docker if not present
    - |
      if ! command -v docker &> /dev/null; then
        curl -fsSL https://get.docker.com | sh
        systemctl start docker || service docker start || true
      fi
    - docker --version
    # Login to GitLab Container Registry
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - docker build -f packages/server/Dockerfile -t $SERVER_IMAGE:latest -t $SERVER_IMAGE:$CI_COMMIT_SHORT_SHA .
    - docker push $SERVER_IMAGE:latest
    - docker push $SERVER_IMAGE:$CI_COMMIT_SHORT_SHA
    # Tag with version if this is a tag build
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        docker tag $SERVER_IMAGE:latest $SERVER_IMAGE:$CI_COMMIT_TAG
        docker push $SERVER_IMAGE:$CI_COMMIT_TAG
      fi
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
      allow_failure: true

# ===================
# Web Docker Build
# ===================
build:web:
  stage: docker
  tags:
    - debian
  variables:
    PLATFORM_CACHE_KEY: "build-web"
  before_script:
    # Install Docker if not present
    - |
      if ! command -v docker &> /dev/null; then
        curl -fsSL https://get.docker.com | sh
        systemctl start docker || service docker start || true
      fi
    - docker --version
    # Login to GitLab Container Registry
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - docker build -f packages/web/Dockerfile -t $WEB_IMAGE:latest -t $WEB_IMAGE:$CI_COMMIT_SHORT_SHA .
    - docker push $WEB_IMAGE:latest
    - docker push $WEB_IMAGE:$CI_COMMIT_SHORT_SHA
    # Tag with version if this is a tag build
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        docker tag $WEB_IMAGE:latest $WEB_IMAGE:$CI_COMMIT_TAG
        docker push $WEB_IMAGE:$CI_COMMIT_TAG
      fi
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
      allow_failure: true

# ===================
# Build All (triggered manually or by tag)
# ===================
build:all:
  stage: docker
  tags:
    - debian
  script:
    - echo "All platform builds completed"
  needs:
    - job: build:windows
      optional: true
    - job: build:linux
      optional: true
    - job: build:macos
      optional: true
    - job: build:server
      optional: true
    - job: build:web
      optional: true
  rules:
    - if: $CI_COMMIT_TAG

# ===================
# Deploy Jobs (tagged releases only)
# ===================
# All platforms deploy to /pool/releases/<repo-name>/<tag>/ on dpiprox2 (192.168.100.22)

deploy:linux:
  stage: deploy
  tags:
    - linux
  script:
    - mkdir -p /mnt/releases/$CI_PROJECT_NAME/$CI_COMMIT_REF_NAME
    - cp -r packages/desktop/release/* /mnt/releases/$CI_PROJECT_NAME/$CI_COMMIT_REF_NAME/
  needs:
    - job: build:linux
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
      allow_failure: true

deploy:windows:
  stage: deploy
  tags:
    - windows
  script:
    - 'net use R: \\192.168.100.22\releases gitlab /user:root'
    - 'New-Item -ItemType Directory -Force -Path "R:\$env:CI_PROJECT_NAME\$env:CI_COMMIT_REF_NAME"'
    - 'Copy-Item -Recurse packages\desktop\release\* "R:\$env:CI_PROJECT_NAME\$env:CI_COMMIT_REF_NAME"'
    - 'net use R: /delete'
  needs:
    - job: build:windows
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
      allow_failure: true

deploy:macos:
  stage: deploy
  tags:
    - macos
  script:
    # Clean up any stale mount from previous runs
    - umount /tmp/releases 2>/dev/null || true
    - mkdir -p /tmp/releases
    - mount_smbfs //root:gitlab@192.168.100.22/releases /tmp/releases
    - mkdir -p /tmp/releases/$CI_PROJECT_NAME/$CI_COMMIT_REF_NAME
    - cp -r packages/desktop/release/* /tmp/releases/$CI_PROJECT_NAME/$CI_COMMIT_REF_NAME/
    - umount /tmp/releases
  needs:
    - job: build:macos
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
      allow_failure: true
